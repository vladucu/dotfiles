{{- if (eq .chezmoi.os "darwin") -}}
#!/bin/sh

# Install common macOS packages

printf "${green}[10 - macOS] ${reset}"
{{- if or (lt 10 (atoi (env "SCRIPTS_START_AT"))) (env "SKIP_BREW") }}
echo "Skip installing common macOS packages"
exit 0
{{ else }}
echo "Install common macOS packages"
{{- end }}

set -eufo pipefail

# Ensure brew is available. Covers the initial run of chezmoi when dotfiles have not been created yet.
eval "$(/opt/homebrew/bin/brew shellenv)"
{{ if .multi_user -}}
alias brew='sudo -Hu ops -i brew'
{{- end }}

{{ $taps := list
    "homebrew/cask-versions"
    "homebrew/cask-fonts"
-}}

{{ $brews := list
    "asdf"
    "bash"
    "bat"
    "chezmoi"
    "cmake"
    "curl"
    "exa"
    "fd"
    "fzf"
    "gh"
    "ghq"
    "git-delta"
    "git"
    "gpg"
    "less"
    "mackup"
    "navi"
    "neovim"
    "pinentry-mac"
    "reattach-to-user-namespace"
    "ripgrep"
    "sheldon"
    "tig"
    "tmux"
    "wget"
    "zsh"
-}}

{{ $casks := list
    "1password-beta"
    "1password-cli"
    "adobe-acrobat-reader"
    "alacritty"
    "appcleaner"
    "brave-browser"
    "discord"
    "flux"
    "font-fira-code-nerd-font"
    "font-hack-nerd-font"
    "google-chrome"
    "hiddenbar"
    "iina"
    "iterm2"
    "karabiner-elements"
    "licecap"
    "raycast"
    "signal"
    "spideroakone"
    "telegram"
    "transmission"
    "todoist"
    "visual-studio-code"
    "whatsapp"
-}}

{{ if .smile -}}
{{  $brews = concat $brews (list
        "awscli"
        "docker-credential-helper-ecr"
        "helm"
        "kubectl"
        "vault"
    ) -}}
{{  $casks = concat $casks (list
        "aws-vault"
        "docker"
        "keybase"
        "loom"
        "postico"
        "slack"
        "tunnelblick"
        "zoom"
    ) -}}
{{ end -}}

sh -c "echo $(which brew)"

cat <<EOF >/tmp/Brews
#!/bin/sh
{{ range ($taps | sortAlpha | uniq) -}}
tap "{{ . }}"
{{ end }}
{{ range ($brews | sortAlpha | uniq) -}}
brew "{{ . }}"
{{ end }}
{{ range ($casks | sortAlpha | uniq) -}}
cask "{{ . }}"
{{ end -}}
EOF

brew bundle --no-lock --file=/tmp/Brews

{{ end -}}
